#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "üîí Running pre-commit checks..."

# Check for any console.log or debug statements
if grep -r "console.log" entry/src/main/ets --include="*.ets" 2>/dev/null; then
    echo "‚ùå Found console.log statements. Please remove them before committing."
    exit 1
fi

# Check for TODO/FIXME markers
echo "üìã Checking TODO/FIXME markers..."
TODO_COUNT=$(grep -r "TODO\|FIXME" entry/src/main/ets --include="*.ets" | wc -l)
if [ "$TODO_COUNT" -gt 0 ]; then
    echo "‚ö†Ô∏è  Found $TODO_COUNT TODO/FIXME markers in code"
fi

# Run code linting (if hvigorw is available)
if command -v hvigorw &> /dev/null; then
    echo "üîç Running code linter..."
    hvigorw code-lint --parallel
    if [ $? -ne 0 ]; then
        echo "‚ùå Code linting failed. Please fix the issues."
        exit 1
    fi
fi

# Run automated tests (critical!)
echo ""
echo "üß™ Running automated tests (required to pass)..."
echo "------------------------------------------------"

if [ -f "$(dirname "$0")/run-tests.sh" ]; then
    bash "$(dirname "$0")/run-tests.sh"
    if [ $? -ne 0 ]; then
        echo ""
        echo "‚ùå Tests failed! Commit aborted."
        echo "Please fix the failing tests before committing."
        echo "Run 'npm run test' for more details."
        exit 1
    fi
else
    # Fallback: run basic test command
    if command -v hvigorw &> /dev/null; then
        hvigorw test --parallel
        if [ $? -ne 0 ]; then
            echo "‚ùå Tests failed! Commit aborted."
            exit 1
        fi
    fi
fi

echo ""
echo "‚úÖ Pre-commit checks and tests passed!"
echo "Commit will proceed..."
