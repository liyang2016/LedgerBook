#!/bin/sh

echo "üöÄ Running pre-push checks..."

# Check if we have uncommitted changes
if ! git diff-index --quiet HEAD --; then
    echo "‚ùå You have uncommitted changes. Please commit or stash them before pushing."
    exit 1
fi

# Run all tests before pushing
echo "üß™ Running all tests before push..."
if command -v hvigorw &> /dev/null; then
    hvigorw test
    if [ $? -ne 0 ]; then
        echo "‚ùå Tests failed. Please fix them before pushing."
        exit 1
    fi
else
    echo "‚ö†Ô∏è  hvigorw not found, skipping tests"
fi

# Check if branch is up to date
echo "üì• Checking if branch is up to date..."
git fetch origin
LOCAL=$(git rev-parse @)
REMOTE=$(git rev-parse @{u})
BASE=$(git merge-base @ @{u})

if [ $LOCAL = $REMOTE ]; then
    echo "‚úÖ Branch is up to date"
elif [ $LOCAL = $BASE ]; then
    echo "‚ö†Ô∏è  Need to pull changes from remote first"
    exit 1
elif [ $REMOTE = $BASE ]; then
    echo "‚úÖ Can push to remote"
else
    echo "‚ùå Branch has diverged from remote. Please resolve conflicts."
    exit 1
fi

echo "‚úÖ Pre-push checks passed! Ready to push."
