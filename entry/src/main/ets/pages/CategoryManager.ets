import { DataManager, Category } from '../services/DataManager'
import { BottomNavBar } from '../components/BottomNavBar'
import router from '@ohos.router'

@Entry
@Component
struct CategoryManager {
  @State categories: Category[] = []
  @State currentTab: 'income' | 'expense' = 'expense'
  @State showAddDialog: boolean = false
  @State newCategoryName: string = ''
  @State newCategoryIcon: string = ''
  private dataManager: DataManager = DataManager.getInstance()

  async aboutToAppear(): Promise<void> {
    await this.loadCategories()
  }

  async loadCategories(): Promise<void> {
    this.categories = await this.dataManager.getCategories()
  }

  getFilteredCategories(): Category[] {
    return this.categories.filter(cat => cat.type === this.currentTab)
  }

  getAvailableIcons(): string[] {
    const usedIcons = this.categories.map(cat => cat.icon)
    const allIcons = ['ğŸ”', 'ğŸš—', 'ğŸ›’', 'ğŸ®', 'ğŸ’Š', 'ğŸ“š', 'ğŸ ', 'ğŸ’°', 'ğŸ', 'ğŸ“ˆ', 'ğŸ’¼', 'â˜•', 'ğŸ¿', 'âœˆï¸', 'ğŸ’»', 'ğŸ¬', 'ğŸƒ', 'ğŸ’‡', 'ğŸµ', 'ğŸ“±', 'ğŸŒŸ', 'ğŸ¨', 'ğŸ•', 'ğŸš‡']
    return allIcons.filter(icon => !usedIcons.includes(icon))
  }

  async addCategory(): Promise<void> {
    if (!this.newCategoryName || !this.newCategoryIcon) {
      return
    }

    const newCategory: Category = {
      name: this.newCategoryName,
      icon: this.newCategoryIcon,
      type: this.currentTab
    }

    this.categories.push(newCategory)
    await this.dataManager.saveCategories(this.categories)
    await this.loadCategories()
    this.showAddDialog = false
    this.newCategoryName = ''
    this.newCategoryIcon = ''
  }

  async deleteCategory(category: Category): Promise<void> {
    const index = this.categories.findIndex(cat => cat.name === category.name && cat.type === category.type)
    if (index !== -1) {
      this.categories.splice(index, 1)
      await this.dataManager.saveCategories(this.categories)
      await this.loadCategories()
    }
  }

  build() {
    Stack() {
      Column() {
        Row() {
          Text('åˆ†ç±»ç®¡ç†')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
            .layoutWeight(1)
            .textAlign(TextAlign.Center)

          Button() {
            Text('+')
              .fontSize(22)
              .fontColor('#FFFFFF')
          }
          .width(40)
          .height(40)
          .backgroundColor('#2196F3')
          .borderRadius(8)
          .onClick(() => {
            this.showAddDialog = true
          })
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 16, bottom: 16 })
        .backgroundColor('#FFFFFF')

        Row() {
          Button('æ”¯å‡º')
            .width('48%')
            .height(40)
            .backgroundColor(this.currentTab === 'expense' ? '#F44336' : '#F0F0F0')
            .fontColor(this.currentTab === 'expense' ? '#FFFFFF' : '#757575')
            .fontSize(15)
            .fontWeight(FontWeight.Medium)
            .borderRadius(6)
            .onClick(() => {
              this.currentTab = 'expense'
            })

          Button('æ”¶å…¥')
            .width('48%')
            .height(40)
            .backgroundColor(this.currentTab === 'income' ? '#4CAF50' : '#F0F0F0')
            .fontColor(this.currentTab === 'income' ? '#FFFFFF' : '#757575')
            .fontSize(15)
            .fontWeight(FontWeight.Medium)
            .borderRadius(6)
            .onClick(() => {
              this.currentTab = 'income'
            })
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
        .justifyContent(FlexAlign.SpaceBetween)

        if (this.getFilteredCategories().length === 0) {
          Column() {
            Text('æš‚æ— åˆ†ç±»')
              .fontSize(16)
              .fontColor('#9E9E9E')
              .margin({ top: 40 })
            Text('ç‚¹å‡»å³ä¸Šè§’"+"æ·»åŠ åˆ†ç±»')
              .fontSize(14)
              .fontColor('#BDBDBD')
              .margin({ top: 8 })
          }
          .width('100%')
          .layoutWeight(1)
        } else {
          List({ space: 8 }) {
            ForEach(this.getFilteredCategories(), (category: Category) => {
              ListItem() {
                Row() {
                  Text(category.icon)
                    .fontSize(28)

                  Text(category.name)
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#1A1A1A')
                    .margin({ left: 16 })

                  Blank()

                  Button() {
                    Text('åˆ é™¤')
                      .fontSize(13)
                      .fontColor('#F44336')
                  }
                  .backgroundColor('#FFEBEE')
                  .height(32)
                  .padding({ left: 14, right: 14 })
                  .borderRadius(4)
                  .onClick(() => {
                    this.deleteCategory(category)
                  })
                }
                .width('100%')
                .padding(16)
                .backgroundColor('#F5F5F5')
                .borderRadius(6)
                .border({ width: 1, color: '#EEEEEE' })
              }
            })
          }
          .width('100%')
          .layoutWeight(1)
          .padding({ left: 16, right: 16, top: 16 })
        }

        // åº•éƒ¨å¯¼èˆªæ å ä½
        Blank()
          .height(56)
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#FAFAFA')

      if (this.showAddDialog) {
        Column() {
          Column() {
            Text('æ·»åŠ åˆ†ç±»')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1A1A1A')
              .width('100%')
              .margin({ bottom: 24 })

            Column() {
              Text('åˆ†ç±»åç§°')
                .fontSize(13)
                .fontColor('#757575')
                .width('100%')
                .margin({ bottom: 12 })

              TextInput({ placeholder: 'è¯·è¾“å…¥åˆ†ç±»åç§°', text: this.newCategoryName })
                .fontSize(15)
                .fontColor('#1A1A1A')
                .backgroundColor('#F5F5F5')
                .borderRadius(6)
                .height(48)
                .onChange((value: string) => {
                  this.newCategoryName = value
                })
            }
            .width('100%')
            .margin({ bottom: 24 })

            Column() {
              Text('é€‰æ‹©å›¾æ ‡')
                .fontSize(13)
                .fontColor('#757575')
                .width('100%')
                .margin({ bottom: 16 })

              Flex({ wrap: FlexWrap.Wrap }) {
                ForEach(this.getAvailableIcons(), (icon: string) => {
                  Text(icon)
                    .fontSize(28)
                    .padding(12)
                    .backgroundColor(this.newCategoryIcon === icon ? '#2196F3' : '#F0F0F0')
                    .borderRadius(6)
                    .margin({ right: 10, bottom: 10 })
                    .onClick(() => {
                      this.newCategoryIcon = icon
                    })
                })
              }
              .width('100%')
            }
            .width('100%')
            .margin({ bottom: 32 })

            Row() {
              Button('å–æ¶ˆ')
                .width('48%')
                .height(48)
                .fontSize(16)
                .fontColor('#757575')
                .backgroundColor('#F0F0F0')
                .borderRadius(6)
                .onClick(() => {
                  this.showAddDialog = false
                  this.newCategoryName = ''
                  this.newCategoryIcon = ''
                })

              Button('æ·»åŠ ')
                .width('48%')
                .height(48)
                .fontSize(16)
                .fontColor('#FFFFFF')
                .backgroundColor('#2196F3')
                .borderRadius(6)
                .onClick(async () => {
                  await this.addCategory()
                })
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
          }
          .width('100%')
          .padding(24)
          .backgroundColor('#FFFFFF')
          .borderRadius(8)
        }
        .width('100%')
        .height('100%')
        .backgroundColor('#00000080')
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          this.showAddDialog = false
        })
      }

      // åº•éƒ¨å¯¼èˆªæ å›ºå®šåœ¨åº•éƒ¨
      Column() {
        BottomNavBar({ currentPageIndex: 2 })
      }
      .width('100%')
      .height(56)
      .position({ x: 0, y: '100%' })
      .translate({ y: -56 })
      .zIndex(100)
    }
    .width('100%')
    .height('100%')
  }
}
