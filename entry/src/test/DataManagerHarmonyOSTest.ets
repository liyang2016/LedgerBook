import { describe, beforeAll, beforeEach, afterEach, afterAll, it, expect } from '@ohos/hypium';
import { DataManager, Transaction, Category, BalanceSummary } from '../../main/ets/services/DataManager';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { BusinessError } from '@ohos/base';

/**
 * DataManager æµ‹è¯•å¥—ä»¶
 * åŸºäº HarmonyOS æµ‹è¯•è§„èŒƒå®ç°
 * 
 * æµ‹è¯•çº§åˆ«:
 * - L0: å¿«é€Ÿå•å…ƒæµ‹è¯•ï¼ˆ<100msï¼‰
 * - L1: å®Œæ•´å•å…ƒæµ‹è¯•ï¼ˆ<500msï¼‰
 * - L2: é›†æˆæµ‹è¯•ï¼ˆ<2000msï¼‰
 * - L3: ç³»ç»Ÿæµ‹è¯•ï¼ˆ<5000msï¼‰
 */
export default function DataManagerHarmonyOSTest() {
  describe('DataManager HarmonyOS Test Suite', () => {
    
    let dataManager: DataManager;
    let testContext: Context;
    const TEST_TAG = 'DataManagerTest';

    // ==================== æµ‹è¯•ç”Ÿå‘½å‘¨æœŸ ====================

    beforeAll(async () => {
      hilog.info(0x0000, TEST_TAG, 'å¼€å§‹åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ');
      
      try {
        dataManager = DataManager.getInstance();
        testContext = getContext(this);
        
        await dataManager.init(testContext);
        hilog.info(0x0000, TEST_TAG, 'DataManager åˆå§‹åŒ–æˆåŠŸ');
      } catch (err) {
        const error = err as BusinessError;
        hilog.error(0x0000, TEST_TAG, 'åˆå§‹åŒ–å¤±è´¥: %{public}s', error.message);
        throw err;
      }
    });

    beforeEach(async () => {
      hilog.debug(0x0000, TEST_TAG, 'æ¸…ç†æµ‹è¯•æ•°æ®');
      // æ¯ä¸ªæµ‹è¯•å‰æ¸…ç†æ•°æ®
      await dataManager.saveTransactions([]);
    });

    afterEach(async () => {
      // æ¸…ç†æµ‹è¯•å‰¯ä½œç”¨
      hilog.debug(0x0000, TEST_TAG, 'æµ‹è¯•æ‰§è¡Œå®Œæˆï¼Œæ¸…ç†æ•°æ®');
      await dataManager.saveTransactions([]);
    });

    afterAll(() => {
      hilog.info(0x0000, TEST_TAG, 'æµ‹è¯•å¥—ä»¶æ‰§è¡Œå®Œæˆ');
    });

    // ==================== L0: å¿«é€Ÿå•å…ƒæµ‹è¯• ====================

    describe('L0 - å¿«é€Ÿå•å…ƒæµ‹è¯•', () => {
      
      it('L0-01: å•ä¾‹æ¨¡å¼éªŒè¯', 0, () => {
        const instance1 = DataManager.getInstance();
        const instance2 = DataManager.getInstance();
        
        expect(instance1).assertNotNull();
        expect(instance2).assertNotNull();
        expect(instance1).assertEqual(instance2);
      });

      it('L0-02: é»˜è®¤åˆ†ç±»æ•°é‡éªŒè¯', 0, async () => {
        const categories = await dataManager.getCategories();
        
        expect(categories.length).assertLarger(0);
        
        const expenseCount = categories.filter(c => c.type === 'expense').length;
        const incomeCount = categories.filter(c => c.type === 'income').length;
        
        expect(expenseCount).assertLarger(0);
        expect(incomeCount).assertLarger(0);
        
        hilog.info(0x0000, TEST_TAG, 'åˆ†ç±»æ•°é‡: æ”¯å‡º=%{public}d, æ”¶å…¥=%{public}d', expenseCount, incomeCount);
      });

      it('L0-03: ç©ºæ•°æ®ä½™é¢è®¡ç®—', 0, async () => {
        const summary = await dataManager.calculateBalance();
        
        expect(summary.balance).assertEqual(0);
        expect(summary.totalIncome).assertEqual(0);
        expect(summary.totalExpense).assertEqual(0);
      });

      it('L0-04: äº¤æ˜“æ•°æ®æ ¼å¼éªŒè¯', 0, () => {
        const transaction: Transaction = {
          id: Date.now(),
          title: 'æµ‹è¯•',
          amount: 100,
          type: 'expense',
          date: '2026-02-03',
          category: 'é¤é¥®'
        };
        
        expect(typeof transaction.id).assertEqual('number');
        expect(typeof transaction.title).assertEqual('string');
        expect(typeof transaction.amount).assertEqual('number');
        expect(transaction.type).assertContain('expense');
        expect(transaction.date.match(/^\d{4}-\d{2}-\d{2}$/)).assertNotNull();
      });
    });

    // ==================== L1: å®Œæ•´å•å…ƒæµ‹è¯• ====================

    describe('L1 - å®Œæ•´å•å…ƒæµ‹è¯•', () => {
      
      it('L1-01: æ·»åŠ å•ç¬”äº¤æ˜“', 0, async () => {
        const transaction: Transaction = {
          id: Date.now(),
          title: 'åˆé¤',
          amount: 35,
          type: 'expense',
          date: '2026-02-03',
          category: 'é¤é¥®'
        };

        const startTime = Date.now();
        const success = await dataManager.addTransaction(transaction);
        const duration = Date.now() - startTime;

        expect(success).assertTrue();
        expect(duration).assertLess(500); // L1çº§åˆ« < 500ms

        const transactions = await dataManager.getTransactions();
        expect(transactions.length).assertEqual(1);
        expect(transactions[0].title).assertEqual('åˆé¤');
      });

      it('L1-02: æ‰¹é‡æ·»åŠ äº¤æ˜“ï¼ˆ10æ¡ï¼‰', 0, async () => {
        const transactions: Transaction[] = Array.from({ length: 10 }, (_, i) => ({
          id: Date.now() + i,
          title: `äº¤æ˜“${i}`,
          amount: (i + 1) * 10,
          type: i % 2 === 0 ? 'expense' : 'income',
          date: '2026-02-03',
          category: i % 2 === 0 ? 'é¤é¥®' : 'å·¥èµ„'
        }));

        const startTime = Date.now();
        
        for (const t of transactions) {
          await dataManager.addTransaction(t);
        }
        
        const duration = Date.now() - startTime;
        const saved = await dataManager.getTransactions();
        
        expect(saved.length).assertEqual(10);
        expect(duration).assertLess(1000);
        
        hilog.info(0x0000, TEST_TAG, 'æ‰¹é‡æ·»åŠ 10æ¡äº¤æ˜“è€—æ—¶: %{public}d ms', duration);
      });

      it('L1-03: æ›´æ–°äº¤æ˜“è®°å½•', 0, async () => {
        const original: Transaction = {
          id: 1,
          title: 'åŸæ•°æ®',
          amount: 50,
          type: 'expense',
          date: '2026-02-03',
          category: 'é¤é¥®'
        };
        
        await dataManager.addTransaction(original);
        
        const updated: Transaction = {
          id: 1,
          title: 'ä¿®æ”¹å',
          amount: 75,
          type: 'expense',
          date: '2026-02-03',
          category: 'äº¤é€š'
        };
        
        const success = await dataManager.updateTransaction(updated);
        expect(success).assertTrue();
        
        const transactions = await dataManager.getTransactions();
        expect(transactions[0].title).assertEqual('ä¿®æ”¹å');
        expect(transactions[0].amount).assertEqual(75);
        expect(transactions[0].category).assertEqual('äº¤é€š');
      });

      it('L1-04: åˆ é™¤äº¤æ˜“è®°å½•', 0, async () => {
        const transaction: Transaction = {
          id: 1,
          title: 'å¾…åˆ é™¤',
          amount: 100,
          type: 'expense',
          date: '2026-02-03',
          category: 'é¤é¥®'
        };
        
        await dataManager.addTransaction(transaction);
        let transactions = await dataManager.getTransactions();
        expect(transactions.length).assertEqual(1);
        
        const success = await dataManager.deleteTransaction(1);
        expect(success).assertTrue();
        
        transactions = await dataManager.getTransactions();
        expect(transactions.length).assertEqual(0);
      });

      it('L1-05: ä½™é¢è®¡ç®—å‡†ç¡®æ€§', 0, async () => {
        // æ·»åŠ æ”¶å…¥
        await dataManager.addTransaction({
          id: 1, title: 'å·¥èµ„', amount: 5000, type: 'income',
          date: '2026-02-03', category: 'å·¥èµ„'
        });
        
        // æ·»åŠ æ”¯å‡º
        await dataManager.addTransaction({
          id: 2, title: 'æˆ¿ç§Ÿ', amount: 2000, type: 'expense',
          date: '2026-02-03', category: 'ä½æˆ¿'
        });
        
        await dataManager.addTransaction({
          id: 3, title: 'é¤é¥®', amount: 500, type: 'expense',
          date: '2026-02-03', category: 'é¤é¥®'
        });

        const summary = await dataManager.calculateBalance();
        
        expect(summary.totalIncome).assertEqual(5000);
        expect(summary.totalExpense).assertEqual(2500);
        expect(summary.balance).assertEqual(2500);
      });

      it('L1-06: åˆ†ç±»æ•°æ®æŒä¹…åŒ–', 0, async () => {
        const customCategories: Category[] = [
          { name: 'æµ‹è¯•åˆ†ç±»1', icon: 'ğŸ¯', type: 'expense' },
          { name: 'æµ‹è¯•åˆ†ç±»2', icon: 'ğŸ’', type: 'income' }
        ];
        
        const saveSuccess = await dataManager.saveCategories(customCategories);
        expect(saveSuccess).assertTrue();
        
        const retrieved = await dataManager.getCategories();
        expect(retrieved.length).assertEqual(2);
        expect(retrieved[0].name).assertEqual('æµ‹è¯•åˆ†ç±»1');
      });
    });

    // ==================== L2: é›†æˆæµ‹è¯• ====================

    describe('L2 - é›†æˆæµ‹è¯•', () => {
      
      it('L2-01: å®Œæ•´è®°è´¦æµç¨‹', 0, async () => {
        const startTime = Date.now();
        
        // æ·»åŠ æ”¶å…¥
        await dataManager.addTransaction({
          id: 1, title: 'å·¥èµ„', amount: 5000, type: 'income',
          date: '2026-02-03', category: 'å·¥èµ„'
        });
        
        // æ·»åŠ å¤šç¬”æ”¯å‡º
        const expenses = [
          { id: 2, title: 'æ—©é¤', amount: 15, category: 'é¤é¥®' },
          { id: 3, title: 'åˆé¤', amount: 35, category: 'é¤é¥®' },
          { id: 4, title: 'åœ°é“', amount: 6, category: 'äº¤é€š' },
          { id: 5, title: 'è´­ç‰©', amount: 200, category: 'è´­ç‰©' }
        ];
        
        for (const e of expenses) {
          await dataManager.addTransaction({
            ...e,
            type: 'expense',
            date: '2026-02-03'
          });
        }
        
        // éªŒè¯æ•°æ®
        const transactions = await dataManager.getTransactions();
        expect(transactions.length).assertEqual(5);
        
        // éªŒè¯ç»Ÿè®¡
        const summary = await dataManager.calculateBalance();
        expect(summary.totalIncome).assertEqual(5000);
        expect(summary.totalExpense).assertEqual(256); // 15 + 35 + 6 + 200
        expect(summary.balance).assertEqual(4744);
        
        const duration = Date.now() - startTime;
        expect(duration).assertLess(2000); // L2çº§åˆ« < 2000ms
        
        hilog.info(0x0000, TEST_TAG, 'å®Œæ•´æµç¨‹è€—æ—¶: %{public}d ms', duration);
      });

      it('L2-02: æ‰¹é‡æ“ä½œæ€§èƒ½æµ‹è¯•', 0, async () => {
        const count = 50;
        const transactions: Transaction[] = Array.from({ length: count }, (_, i) => ({
          id: i,
          title: `æ€§èƒ½æµ‹è¯•${i}`,
          amount: Math.floor(Math.random() * 1000),
          type: Math.random() > 0.5 ? 'expense' : 'income',
          date: '2026-02-03',
          category: 'é¤é¥®'
        }));

        const startTime = Date.now();
        
        // æ‰¹é‡æ·»åŠ 
        for (const t of transactions) {
          await dataManager.addTransaction(t);
        }
        
        const addDuration = Date.now() - startTime;
        
        // éªŒè¯æ·»åŠ æˆåŠŸ
        const saved = await dataManager.getTransactions();
        expect(saved.length).assertEqual(count);
        
        // è®¡ç®—ä½™é¢
        const calcStart = Date.now();
        const summary = await dataManager.calculateBalance();
        const calcDuration = Date.now() - calcStart;
        
        expect(calcDuration).assertLess(500);
        expect(summary.totalIncome + summary.totalExpense).assertLarger(0);
        
        hilog.info(0x0000, TEST_TAG, 
          'æ‰¹é‡æ·»åŠ %{public}dæ¡è€—æ—¶: %{public}d ms, è®¡ç®—ä½™é¢è€—æ—¶: %{public}d ms',
          count, addDuration, calcDuration
        );
      });

      it('L2-03: æ•°æ®ä¸€è‡´æ€§éªŒè¯', 0, async () => {
        // æ¨¡æ‹Ÿç”¨æˆ·è¿ç»­æ“ä½œ
        // 1. æ·»åŠ 
        await dataManager.addTransaction({
          id: 1, title: 'T1', amount: 100, type: 'expense',
          date: '2026-02-03', category: 'é¤é¥®'
        });
        
        // 2. ä¿®æ”¹
        await dataManager.updateTransaction({
          id: 1, title: 'T1-ä¿®æ”¹', amount: 150, type: 'expense',
          date: '2026-02-03', category: 'é¤é¥®'
        });
        
        // 3. æ·»åŠ æ›´å¤š
        await dataManager.addTransaction({
          id: 2, title: 'T2', amount: 200, type: 'income',
          date: '2026-02-03', category: 'å·¥èµ„'
        });
        
        // 4. åˆ é™¤
        await dataManager.deleteTransaction(1);
        
        // éªŒè¯æœ€ç»ˆçŠ¶æ€
        const transactions = await dataManager.getTransactions();
        expect(transactions.length).assertEqual(1);
        expect(transactions[0].id).assertEqual(2);
        
        const summary = await dataManager.calculateBalance();
        expect(summary.totalIncome).assertEqual(200);
        expect(summary.totalExpense).assertEqual(0);
      });
    });

    // ==================== L3: ç³»ç»Ÿæµ‹è¯• ====================

    describe('L3 - ç³»ç»Ÿæµ‹è¯•', () => {
      
      it('L3-01: å¤§æ•°æ®é‡å‹åŠ›æµ‹è¯•', 0, async () => {
        const count = 100;
        const startTime = Date.now();
        
        // æ·»åŠ 100æ¡è®°å½•
        for (let i = 0; i < count; i++) {
          await dataManager.addTransaction({
            id: i,
            title: `å¤§æ•°æ®æµ‹è¯•${i}`,
            amount: Math.floor(Math.random() * 500) + 10,
            type: i % 3 === 0 ? 'income' : 'expense',
            date: '2026-02-03',
            category: i % 3 === 0 ? 'å·¥èµ„' : 'é¤é¥®'
          });
        }
        
        const addDuration = Date.now() - startTime;
        
        // éªŒè¯æ•°æ®å®Œæ•´æ€§
        const transactions = await dataManager.getTransactions();
        expect(transactions.length).assertEqual(count);
        
        // æŸ¥è¯¢æ€§èƒ½
        const queryStart = Date.now();
        const summary = await dataManager.calculateBalance();
        const queryDuration = Date.now() - queryStart;
        
        expect(queryDuration).assertLess(1000);
        
        hilog.info(0x0000, TEST_TAG,
          'å¤§æ•°æ®é‡æµ‹è¯•: æ·»åŠ %{public}dæ¡è€—æ—¶%{public}d ms, æŸ¥è¯¢è€—æ—¶%{public}d ms',
          count, addDuration, queryDuration
        );
        
        expect(addDuration).assertLess(5000); // L3çº§åˆ« < 5000ms
      });

      it('L3-02: å¼‚å¸¸æ¢å¤æµ‹è¯•', 0, async () => {
        // å…ˆæ·»åŠ æœ‰æ•ˆæ•°æ®
        await dataManager.addTransaction({
          id: 1, title: 'æœ‰æ•ˆæ•°æ®', amount: 100, type: 'expense',
          date: '2026-02-03', category: 'é¤é¥®'
        });
        
        const beforeCount = (await dataManager.getTransactions()).length;
        
        // å°è¯•æ“ä½œä¸å­˜åœ¨çš„æ•°æ®ï¼ˆä¸åº”å½±å“ç°æœ‰æ•°æ®ï¼‰
        await dataManager.updateTransaction({
          id: 999, title: 'ä¸å­˜åœ¨', amount: 100, type: 'expense',
          date: '2026-02-03', category: 'é¤é¥®'
        });
        
        const afterCount = (await dataManager.getTransactions()).length;
        expect(afterCount).assertEqual(beforeCount);
        
        // éªŒè¯æ•°æ®å®Œæ•´æ€§
        const summary = await dataManager.calculateBalance();
        expect(summary.totalExpense).assertEqual(100);
      });
    });

    // ==================== è¾¹ç•Œæµ‹è¯• ====================

    describe('è¾¹ç•Œæµ‹è¯•', () => {
      
      it('è¾¹ç•Œ-01: é›¶é‡‘é¢äº¤æ˜“', 0, async () => {
        const transaction: Transaction = {
          id: 1,
          title: 'é›¶é‡‘é¢',
          amount: 0,
          type: 'expense',
          date: '2026-02-03',
          category: 'é¤é¥®'
        };
        
        const success = await dataManager.addTransaction(transaction);
        expect(success).assertTrue();
        
        const summary = await dataManager.calculateBalance();
        expect(summary.totalExpense).assertEqual(0);
      });

      it('è¾¹ç•Œ-02: æœ€å¤§é‡‘é¢äº¤æ˜“', 0, async () => {
        const transaction: Transaction = {
          id: 1,
          title: 'å¤§é¢äº¤æ˜“',
          amount: 999999.99,
          type: 'income',
          date: '2026-02-03',
          category: 'å·¥èµ„'
        };
        
        const success = await dataManager.addTransaction(transaction);
        expect(success).assertTrue();
        
        const summary = await dataManager.calculateBalance();
        expect(summary.totalIncome).assertEqual(999999.99);
      });

      it('è¾¹ç•Œ-03: ç‰¹æ®Šå­—ç¬¦æ ‡é¢˜', 0, async () => {
        const transaction: Transaction = {
          id: 1,
          title: 'ç‰¹æ®Š!@#$%^&*()å­—ç¬¦',
          amount: 100,
          type: 'expense',
          date: '2026-02-03',
          category: 'é¤é¥®'
        };
        
        const success = await dataManager.addTransaction(transaction);
        expect(success).assertTrue();
        
        const transactions = await dataManager.getTransactions();
        expect(transactions[0].title).assertEqual('ç‰¹æ®Š!@#$%^&*()å­—ç¬¦');
      });

      it('è¾¹ç•Œ-04: ç©ºå­—ç¬¦ä¸²æ ‡é¢˜', 0, async () => {
        const transaction: Transaction = {
          id: 1,
          title: '',
          amount: 100,
          type: 'expense',
          date: '2026-02-03',
          category: 'é¤é¥®'
        };
        
        const success = await dataManager.addTransaction(transaction);
        expect(success).assertTrue();
        
        const transactions = await dataManager.getTransactions();
        expect(transactions[0].title).assertEqual('');
      });

      it('è¾¹ç•Œ-05: é•¿æ ‡é¢˜ï¼ˆ100å­—ç¬¦ï¼‰', 0, async () => {
        const longTitle = 'è¿™æ˜¯ä¸€ä¸ªéå¸¸éå¸¸é•¿çš„æ ‡é¢˜ï¼Œç”¨äºæµ‹è¯•ç³»ç»Ÿå¯¹é•¿æ–‡æœ¬çš„å¤„ç†èƒ½åŠ›'.repeat(2);
        const transaction: Transaction = {
          id: 1,
          title: longTitle,
          amount: 100,
          type: 'expense',
          date: '2026-02-03',
          category: 'é¤é¥®'
        };
        
        const success = await dataManager.addTransaction(transaction);
        expect(success).assertTrue();
        
        const transactions = await dataManager.getTransactions();
        expect(transactions[0].title.length).assertEqual(longTitle.length);
      });
    });

    // ==================== é”™è¯¯å¤„ç†æµ‹è¯• ====================

    describe('é”™è¯¯å¤„ç†æµ‹è¯•', () => {
      
      it('é”™è¯¯-01: æ›´æ–°ä¸å­˜åœ¨çš„äº¤æ˜“', 0, async () => {
        const nonExistent: Transaction = {
          id: 999,
          title: 'ä¸å­˜åœ¨',
          amount: 100,
          type: 'expense',
          date: '2026-02-03',
          category: 'é¤é¥®'
        };
        
        const success = await dataManager.updateTransaction(nonExistent);
        expect(success).assertFalse();
      });

      it('é”™è¯¯-02: åˆ é™¤ä¸å­˜åœ¨çš„äº¤æ˜“', 0, async () => {
        const success = await dataManager.deleteTransaction(999);
        // åˆ é™¤ä¸å­˜åœ¨çš„æ•°æ®åº”è¿”å› trueï¼ˆæ— å‰¯ä½œç”¨ï¼‰
        expect(success).assertTrue();
      });

      it('é”™è¯¯-03: è´Ÿæ•°é‡‘é¢', 0, async () => {
        // æ³¨æ„ï¼šå½“å‰å®ç°å…è®¸è´Ÿæ•°ï¼Œä½†ä¸šåŠ¡é€»è¾‘åº”è¯¥æ‹’ç»
        const transaction: Transaction = {
          id: 1,
          title: 'è´Ÿæ•°é‡‘é¢',
          amount: -100,
          type: 'expense',
          date: '2026-02-03',
          category: 'é¤é¥®'
        };
        
        const success = await dataManager.addTransaction(transaction);
        // è®°å½•å½“å‰è¡Œä¸ºï¼ˆå°†æ¥åº”è¯¥æ”¹ä¸ºéªŒè¯æ‹’ç»ï¼‰
        hilog.warn(0x0000, TEST_TAG, 'è´Ÿæ•°é‡‘é¢è¢«æ¥å—ï¼Œå»ºè®®æ·»åŠ éªŒè¯');
        expect(success).assertTrue();
      });
    });
  });
}
