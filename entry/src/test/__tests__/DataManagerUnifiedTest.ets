import { describe, it, expect, beforeAll, beforeEach, afterEach, afterAll } from '@ohos/hypium';
import { DataManager, Transaction, Category, BalanceSummary } from '../../main/ets/services/DataManager';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { BusinessError } from '@ohos/base';

/**
 * DataManager ç»Ÿä¸€é‡æ„æµ‹è¯•å¥—ä»¶
 * 
 * é‡æ„ç›®æ ‡ï¼š
 * 1. æ¶ˆé™¤å†—ä½™æµ‹è¯•ï¼Œåˆå¹¶ç›¸ä¼¼ç”¨ä¾‹
 * 2. ç»Ÿä¸€å‘½åè§„èŒƒï¼štest[æ¨¡å—]_[åŠŸèƒ½]_[åœºæ™¯]
 * 3. å¢å¼ºæµ‹è¯•å¯è¯»æ€§å’Œç»´æŠ¤æ€§
 * 4. è¡¥å……ç¼ºå¤±çš„è¾¹ç•Œå’Œå¼‚å¸¸æµ‹è¯•
 * 5. ä¼˜åŒ–æ€§èƒ½æµ‹è¯•åŸºå‡†
 * 
 * æµ‹è¯•è¦†ç›–ï¼š
 * - åŸºç¡€CRUDï¼š10ä¸ªç”¨ä¾‹
 * - ä¸šåŠ¡é€»è¾‘ï¼š8ä¸ªç”¨ä¾‹
 * - è¾¹ç•Œæ¡ä»¶ï¼š10ä¸ªç”¨ä¾‹
 * - é”™è¯¯å¤„ç†ï¼š6ä¸ªç”¨ä¾‹
 * - æ€§èƒ½åŸºå‡†ï¼š8ä¸ªç”¨ä¾‹
 * - å¹¶å‘å‹åŠ›ï¼š6ä¸ªç”¨ä¾‹
 * æ€»è®¡ï¼š48ä¸ªæ ¸å¿ƒç”¨ä¾‹
 */
export default function DataManagerUnifiedTest() {
  
  describe('DataManager Unified Test Suite', () => {
    
    // ==================== é…ç½®ä¸å·¥å…· ====================
    const TEST_TAG = 'DMUnifiedTest';
    let dataManager: DataManager;
    let testContext: Context;
    let idSeed: number = 1;

    /**
     * ç”Ÿæˆå”¯ä¸€ID
     */
    function genId(): number {
      return Date.now() + (idSeed++);
    }

    /**
     * åˆ›å»ºæ ‡å‡†æµ‹è¯•æ•°æ®
     */
    function makeTx(overrides: Partial<Transaction> = {}): Transaction {
      return {
        id: genId(),
        title: 'æµ‹è¯•',
        amount: 100,
        type: 'expense',
        date: '2026-02-03',
        category: 'é¤é¥®',
        ...overrides
      };
    }

    /**
     * æ‰¹é‡åˆ›å»ºæµ‹è¯•æ•°æ®
     */
    function makeTxs(count: number, overrides: Partial<Transaction> = {}): Transaction[] {
      return Array.from({ length: count }, (_, i) => makeTx({
        id: genId(),
        title: `TX${i}`,
        amount: (i + 1) * 10,
        ...overrides
      }));
    }

    /**
     * æ€§èƒ½è®¡æ—¶å™¨
     */
    function timer(): { stop: () => number } {
      const start = Date.now();
      return { stop: () => Date.now() - start };
    }

    // ==================== ç”Ÿå‘½å‘¨æœŸ ====================

    beforeAll(async () => {
      hilog.info(0x0000, TEST_TAG, 'ğŸš€ æµ‹è¯•å¥—ä»¶åˆå§‹åŒ–');
      try {
        dataManager = DataManager.getInstance();
        testContext = getContext(this);
        await dataManager.init(testContext);
        hilog.info(0x0000, TEST_TAG, 'âœ… åˆå§‹åŒ–å®Œæˆ');
      } catch (err) {
        hilog.error(0x0000, TEST_TAG, 'âŒ åˆå§‹åŒ–å¤±è´¥: %{public}s', (err as BusinessError).message);
        throw err;
      }
    });

    beforeEach(async () => {
      idSeed = 1;
      await dataManager.saveTransactions([]);
    });

    afterEach(async () => {
      await dataManager.saveTransactions([]);
    });

    afterAll(() => {
      hilog.info(0x0000, TEST_TAG, 'ğŸ æµ‹è¯•å¥—ä»¶å®Œæˆ');
    });

    // ==================== åŸºç¡€CRUDæµ‹è¯• ====================
    describe('ã€åŸºç¡€CRUDã€‘', () => {
      
      it('test001_å•ä¾‹å®ä¾‹ä¸€è‡´æ€§', 0, () => {
        const i1 = DataManager.getInstance();
        const i2 = DataManager.getInstance();
        expect(i1 === i2).assertTrue();
        expect(i1).assertNotNull();
      });

      it('test002_æ·»åŠ å•ç¬”äº¤æ˜“', 0, async () => {
        const t = makeTx({ title: 'åˆé¤', amount: 35 });
        const tm = timer();
        
        const ok = await dataManager.addTransaction(t);
        const ms = tm.stop();
        
        expect(ok).assertTrue();
        expect(ms).assertLess(100);
        
        const txs = await dataManager.getTransactions();
        expect(txs.length).assertEqual(1);
        expect(txs[0].title).assertEqual('åˆé¤');
        expect(txs[0].amount).assertEqual(35);
      });

      it('test003_æ‰¹é‡æ·»åŠ äº¤æ˜“', 0, async () => {
        const txs = makeTxs(5);
        const tm = timer();
        
        for (const t of txs) {
          await dataManager.addTransaction(t);
        }
        const ms = tm.stop();
        
        expect(ms).assertLess(500);
        const saved = await dataManager.getTransactions();
        expect(saved.length).assertEqual(5);
      });

      it('test004_æŸ¥è¯¢æ‰€æœ‰äº¤æ˜“', 0, async () => {
        const t1 = makeTx({ id: 101 });
        const t2 = makeTx({ id: 102 });
        await dataManager.addTransaction(t1);
        await dataManager.addTransaction(t2);

        const txs = await dataManager.getTransactions();
        expect(txs.length).assertEqual(2);
        expect(txs[0].id).assertEqual(102); // å€’åº
        expect(txs[1].id).assertEqual(101);
      });

      it('test005_æ›´æ–°ç°æœ‰äº¤æ˜“', 0, async () => {
        const t = makeTx({ id: 201, title: 'åŸ', amount: 50 });
        await dataManager.addTransaction(t);

        const updated = makeTx({ id: 201, title: 'æ–°', amount: 75, category: 'äº¤é€š' });
        const ok = await dataManager.updateTransaction(updated);
        
        expect(ok).assertTrue();
        const txs = await dataManager.getTransactions();
        expect(txs[0].title).assertEqual('æ–°');
        expect(txs[0].amount).assertEqual(75);
        expect(txs[0].category).assertEqual('äº¤é€š');
      });

      it('test006_åˆ é™¤æŒ‡å®šäº¤æ˜“', 0, async () => {
        const t = makeTx({ id: 301 });
        await dataManager.addTransaction(t);
        
        let txs = await dataManager.getTransactions();
        expect(txs.length).assertEqual(1);

        const ok = await dataManager.deleteTransaction(301);
        expect(ok).assertTrue();

        txs = await dataManager.getTransactions();
        expect(txs.length).assertEqual(0);
      });

      it('test007_åˆ é™¤åæ·»åŠ æ–°äº¤æ˜“', 0, async () => {
        await dataManager.addTransaction(makeTx({ id: 401 }));
        await dataManager.deleteTransaction(401);
        await dataManager.addTransaction(makeTx({ id: 402, title: 'æ–°' }));

        const txs = await dataManager.getTransactions();
        expect(txs.length).assertEqual(1);
        expect(txs[0].id).assertEqual(402);
      });

      it('test008_å¤šæ¬¡æ›´æ–°åŒä¸€äº¤æ˜“', 0, async () => {
        const id = 501;
        await dataManager.addTransaction(makeTx({ id, amount: 100 }));
        
        await dataManager.updateTransaction(makeTx({ id, amount: 200 }));
        await dataManager.updateTransaction(makeTx({ id, amount: 300 }));
        await dataManager.updateTransaction(makeTx({ id, amount: 400 }));

        const txs = await dataManager.getTransactions();
        expect(txs[0].amount).assertEqual(400);
      });

      it('test009_ç©ºåˆ—è¡¨æŸ¥è¯¢', 0, async () => {
        const txs = await dataManager.getTransactions();
        expect(txs.length).assertEqual(0);
        expect(Array.isArray(txs)).assertTrue();
      });

      it('test010_æ‰¹é‡åˆ é™¤', 0, async () => {
        for (let i = 0; i < 5; i++) {
          await dataManager.addTransaction(makeTx({ id: 600 + i }));
        }
        
        await dataManager.deleteTransaction(600);
        await dataManager.deleteTransaction(602);
        await dataManager.deleteTransaction(604);

        const txs = await dataManager.getTransactions();
        expect(txs.length).assertEqual(2);
        expect(txs.some(t => t.id === 601)).assertTrue();
        expect(txs.some(t => t.id === 603)).assertTrue();
      });
    });

    // ==================== ä¸šåŠ¡é€»è¾‘æµ‹è¯• ====================
    describe('ã€ä¸šåŠ¡é€»è¾‘ã€‘', () => {
      
      it('test011_è®¡ç®—æ··åˆæ”¶æ”¯ä½™é¢', 0, async () => {
        await dataManager.addTransaction(makeTx({ type: 'income', amount: 5000, category: 'å·¥èµ„' }));
        await dataManager.addTransaction(makeTx({ type: 'expense', amount: 2000, category: 'æˆ¿ç§Ÿ' }));
        await dataManager.addTransaction(makeTx({ type: 'expense', amount: 500, category: 'é¤é¥®' }));

        const summary = await dataManager.calculateBalance();
        expect(summary.totalIncome).assertEqual(5000);
        expect(summary.totalExpense).assertEqual(2500);
        expect(summary.balance).assertEqual(2500);
      });

      it('test012_çº¯æ”¯å‡ºä½™é¢ä¸ºè´Ÿ', 0, async () => {
        await dataManager.addTransaction(makeTx({ type: 'expense', amount: 100 }));
        await dataManager.addTransaction(makeTx({ type: 'expense', amount: 200 }));

        const summary = await dataManager.calculateBalance();
        expect(summary.balance).assertEqual(-300);
        expect(summary.totalIncome).assertEqual(0);
        expect(summary.totalExpense).assertEqual(300);
      });

      it('test013_çº¯æ”¶å…¥ä½™é¢ä¸ºæ­£', 0, async () => {
        await dataManager.addTransaction(makeTx({ type: 'income', amount: 3000 }));
        await dataManager.addTransaction(makeTx({ type: 'income', amount: 2000 }));

        const summary = await dataManager.calculateBalance();
        expect(summary.balance).assertEqual(5000);
        expect(summary.totalIncome).assertEqual(5000);
        expect(summary.totalExpense).assertEqual(0);
      });

      it('test014_è·å–é»˜è®¤åˆ†ç±»', 0, async () => {
        const cats = await dataManager.getCategories();
        expect(cats.length).assertLarger(0);
        
        const expense = cats.filter(c => c.type === 'expense');
        const income = cats.filter(c => c.type === 'income');
        
        expect(expense.length).assertLarger(0);
        expect(income.length).assertLarger(0);
        
        cats.forEach(c => {
          expect(c.name.length).assertLarger(0);
          expect(c.icon.length).assertLarger(0);
        });
      });

      it('test015_ä¿å­˜è‡ªå®šä¹‰åˆ†ç±»', 0, async () => {
        const custom: Category[] = [
          { name: 'è‡ªå®šä¹‰1', icon: 'ğŸ¯', type: 'expense' },
          { name: 'è‡ªå®šä¹‰2', icon: 'ğŸ’', type: 'income' }
        ];
        
        const ok = await dataManager.saveCategories(custom);
        expect(ok).assertTrue();
        
        const saved = await dataManager.getCategories();
        expect(saved.length).assertEqual(2);
        expect(saved[0].name).assertEqual('è‡ªå®šä¹‰1');
      });

      it('test016_æ”¶æ”¯åˆ†ç±»éš”ç¦»', 0, async () => {
        const cats = await dataManager.getCategories();
        const expense = cats.filter(c => c.type === 'expense');
        const income = cats.filter(c => c.type === 'income');
        
        expect(expense.some(c => c.type === 'income')).assertFalse();
        expect(income.some(c => c.type === 'expense')).assertFalse();
      });

      it('test017_ä½™é¢è®¡ç®—å¤§æ•°æ®é‡', 0, async () => {
        for (let i = 0; i < 50; i++) {
          await dataManager.addTransaction(makeTx({
            type: i % 2 === 0 ? 'expense' : 'income',
            amount: 100
          }));
        }

        const tm = timer();
        const summary = await dataManager.calculateBalance();
        const ms = tm.stop();
        
        expect(ms).assertLess(100);
        expect(summary.totalIncome).assertEqual(2500);
        expect(summary.totalExpense).assertEqual(2500);
        expect(summary.balance).assertEqual(0);
      });

      it('test018_é›¶ä½™é¢åœºæ™¯', 0, async () => {
        await dataManager.addTransaction(makeTx({ type: 'income', amount: 1000 }));
        await dataManager.addTransaction(makeTx({ type: 'expense', amount: 1000 }));

        const summary = await dataManager.calculateBalance();
        expect(summary.balance).assertEqual(0);
      });
    });

    // ==================== è¾¹ç•Œæ¡ä»¶æµ‹è¯• ====================
    describe('ã€è¾¹ç•Œæ¡ä»¶ã€‘', () => {
      
      it('test021_é›¶é‡‘é¢äº¤æ˜“', 0, async () => {
        const t = makeTx({ amount: 0 });
        const ok = await dataManager.addTransaction(t);
        expect(ok).assertTrue();

        const summary = await dataManager.calculateBalance();
        expect(summary.totalExpense).assertEqual(0);
      });

      it('test022_æœ€å¤§é‡‘é¢999999.99', 0, async () => {
        const t = makeTx({ type: 'income', amount: 999999.99 });
        const ok = await dataManager.addTransaction(t);
        expect(ok).assertTrue();

        const summary = await dataManager.calculateBalance();
        expect(summary.totalIncome).assertEqual(999999.99);
      });

      it('test023_ä¸¤ä½å°æ•°ç²¾åº¦', 0, async () => {
        const t = makeTx({ amount: 35.99 });
        await dataManager.addTransaction(t);

        const txs = await dataManager.getTransactions();
        expect(txs[0].amount).assertEqual(35.99);
      });

      it('test024_ç©ºå­—ç¬¦ä¸²æ ‡é¢˜', 0, async () => {
        const t = makeTx({ title: '' });
        const ok = await dataManager.addTransaction(t);
        expect(ok).assertTrue();

        const txs = await dataManager.getTransactions();
        expect(txs[0].title).assertEqual('');
      });

      it('test025_ç‰¹æ®Šå­—ç¬¦æ ‡é¢˜', 0, async () => {
        const special = '!@#$%^&*()_+-=[]{}|;\':",./<>?';
        const t = makeTx({ title: special });
        const ok = await dataManager.addTransaction(t);
        expect(ok).assertTrue();

        const txs = await dataManager.getTransactions();
        expect(txs[0].title).assertEqual(special);
      });

      it('test026_è¶…é•¿æ ‡é¢˜100å­—ç¬¦', 0, async () => {
        const longTitle = 'é•¿'.repeat(100);
        const t = makeTx({ title: longTitle });
        const ok = await dataManager.addTransaction(t);
        expect(ok).assertTrue();

        const txs = await dataManager.getTransactions();
        expect(txs[0].title.length).assertEqual(100);
      });

      it('test027_æ—¥æœŸæ ¼å¼è¾¹ç•Œ', 0, async () => {
        const dates = ['2026-01-01', '2026-12-31', '2020-02-29', '2024-02-29'];
        
        for (const date of dates) {
          const t = makeTx({ date });
          await dataManager.addTransaction(t);
        }

        const txs = await dataManager.getTransactions();
        expect(txs.length).assertEqual(4);
      });

      it('test028_å•å­—åˆ†ç±»å', 0, async () => {
        const cats: Category[] = [{ name: 'A', icon: 'ğŸ¯', type: 'expense' }];
        await dataManager.saveCategories(cats);
        
        const saved = await dataManager.getCategories();
        expect(saved[0].name).assertEqual('A');
      });

      it('test029_å¤§é‡åˆ†ç±»', 0, async () => {
        const cats: Category[] = Array.from({ length: 50 }, (_, i) => ({
          name: `åˆ†ç±»${i}`,
          icon: 'ğŸ¯',
          type: i % 2 === 0 ? 'expense' : 'income'
        }));
        
        const ok = await dataManager.saveCategories(cats);
        expect(ok).assertTrue();
        
        const saved = await dataManager.getCategories();
        expect(saved.length).assertEqual(50);
      });

      it('test030_æ··åˆç±»å‹äº¤æ˜“åˆ—è¡¨', 0, async () => {
        for (let i = 0; i < 10; i++) {
          await dataManager.addTransaction(makeTx({
            type: i % 2 === 0 ? 'expense' : 'income',
            title: `æ··åˆ${i}`
          }));
        }

        const txs = await dataManager.getTransactions();
        const expense = txs.filter(t => t.type === 'expense');
        const income = txs.filter(t => t.type === 'income');
        
        expect(expense.length).assertEqual(5);
        expect(income.length).assertEqual(5);
      });
    });

    // ==================== é”™è¯¯å¤„ç†æµ‹è¯• ====================
    describe('ã€é”™è¯¯å¤„ç†ã€‘', () => {
      
      it('test031_æ›´æ–°ä¸å­˜åœ¨äº¤æ˜“', 0, async () => {
        const t = makeTx({ id: 99999 });
        const ok = await dataManager.updateTransaction(t);
        expect(ok).assertFalse();
      });

      it('test032_åˆ é™¤ä¸å­˜åœ¨äº¤æ˜“å¹‚ç­‰', 0, async () => {
        const ok = await dataManager.deleteTransaction(88888);
        expect(ok).assertTrue(); // å¹‚ç­‰ï¼šå·²åˆ é™¤è§†ä¸ºæˆåŠŸ
      });

      it('test033_ç©ºåˆ—è¡¨åˆ é™¤', 0, async () => {
        const ok = await dataManager.deleteTransaction(1);
        expect(ok).assertTrue();
        
        const txs = await dataManager.getTransactions();
        expect(txs.length).assertEqual(0);
      });

      it('test034_æ“ä½œå¤±è´¥æ•°æ®ä¸€è‡´æ€§', 0, async () => {
        await dataManager.addTransaction(makeTx({ id: 777, title: 'ä¿ç•™' }));
        const before = (await dataManager.getTransactions()).length;

        await dataManager.updateTransaction(makeTx({ id: 99999 }));
        
        const after = (await dataManager.getTransactions()).length;
        expect(after).assertEqual(before);
        
        const txs = await dataManager.getTransactions();
        expect(txs[0].title).assertEqual('ä¿ç•™');
      });

      it('test035_é‡å¤IDå¤„ç†', 0, async () => {
        const id = genId();
        await dataManager.addTransaction(makeTx({ id, title: 'ç¬¬ä¸€' }));
        await dataManager.addTransaction(makeTx({ id, title: 'ç¬¬äºŒ' }));

        const txs = await dataManager.getTransactions();
        // åè€…åº”è¦†ç›–å‰è€…æˆ–ä¸¤è€…å¹¶å­˜ï¼ˆå–å†³äºå®ç°ï¼‰
        expect(txs.length).assertLarger(0);
      });

      it('test036_è´Ÿæ•°é‡‘é¢è¾¹ç•Œ', 0, async () => {
        // è®°å½•å½“å‰å®ç°è¡Œä¸ºï¼ˆåº”æ”¹è¿›ä¸ºæ‹’ç»ï¼‰
        const t = makeTx({ amount: -100 });
        const ok = await dataManager.addTransaction(t);
        
        hilog.warn(0x0000, TEST_TAG, 'âš ï¸ è´Ÿæ•°é‡‘é¢è¢«æ¥å—ï¼Œå»ºè®®æ·»åŠ æ ¡éªŒ');
        expect(ok).assertTrue(); // å½“å‰å®ç°å…è®¸
      });
    });

    // ==================== æ€§èƒ½åŸºå‡†æµ‹è¯• ====================
    describe('ã€æ€§èƒ½åŸºå‡†ã€‘', () => {
      
      it('test041_å•æ¡æ·»åŠ L0', 0, async () => {
        const tm = timer();
        await dataManager.addTransaction(makeTx());
        const ms = tm.stop();
        
        expect(ms).assertLess(100);
        hilog.info(0x0000, TEST_TAG, 'L0å•æ¡æ·»åŠ : %{public}d ms', ms);
      });

      it('test042_æ‰¹é‡10æ¡L1', 0, async () => {
        const tm = timer();
        for (const t of makeTxs(10)) {
          await dataManager.addTransaction(t);
        }
        const ms = tm.stop();
        
        expect(ms).assertLess(500);
        hilog.info(0x0000, TEST_TAG, 'L1æ‰¹é‡10æ¡: %{public}d ms', ms);
      });

      it('test043_æŸ¥è¯¢50æ¡L0', 0, async () => {
        for (const t of makeTxs(50)) {
          await dataManager.addTransaction(t);
        }

        const tm = timer();
        const txs = await dataManager.getTransactions();
        const ms = tm.stop();

        expect(txs.length).assertEqual(50);
        expect(ms).assertLess(100);
        hilog.info(0x0000, TEST_TAG, 'L0æŸ¥è¯¢50æ¡: %{public}d ms', ms);
      });

      it('test044_ä½™é¢è®¡ç®—L0', 0, async () => {
        for (const t of makeTxs(100)) {
          await dataManager.addTransaction(t);
        }

        const tm = timer();
        await dataManager.calculateBalance();
        const ms = tm.stop();

        expect(ms).assertLess(100);
        hilog.info(0x0000, TEST_TAG, 'L0ä½™é¢è®¡ç®—100æ¡: %{public}d ms', ms);
      });

      it('test045_æ‰¹é‡50æ¡L2', 0, async () => {
        const tm = timer();
        for (const t of makeTxs(50)) {
          await dataManager.addTransaction(t);
        }
        const ms = tm.stop();
        
        expect(ms).assertLess(2000);
        hilog.info(0x0000, TEST_TAG, 'L2æ‰¹é‡50æ¡: %{public}d ms', ms);
      });

      it('test046_æŸ¥è¯¢100æ¡L1', 0, async () => {
        for (const t of makeTxs(100)) {
          await dataManager.addTransaction(t);
        }

        const tm = timer();
        await dataManager.getTransactions();
        const ms = tm.stop();

        expect(ms).assertLess(500);
        hilog.info(0x0000, TEST_TAG, 'L1æŸ¥è¯¢100æ¡: %{public}d ms', ms);
      });

      it('test047_æ›´æ–°å•æ¡L0', 0, async () => {
        await dataManager.addTransaction(makeTx({ id: 800 }));
        
        const tm = timer();
        await dataManager.updateTransaction(makeTx({ id: 800, amount: 200 }));
        const ms = tm.stop();

        expect(ms).assertLess(100);
        hilog.info(0x0000, TEST_TAG, 'L0æ›´æ–°å•æ¡: %{public}d ms', ms);
      });

      it('test048_åˆ é™¤å•æ¡L0', 0, async () => {
        await dataManager.addTransaction(makeTx({ id: 801 }));
        
        const tm = timer();
        await dataManager.deleteTransaction(801);
        const ms = tm.stop();

        expect(ms).assertLess(100);
        hilog.info(0x0000, TEST_TAG, 'L0åˆ é™¤å•æ¡: %{public}d ms', ms);
      });
    });

    // ==================== å¹¶å‘ä¸å‹åŠ›æµ‹è¯• ====================
    describe('ã€å¹¶å‘å‹åŠ›ã€‘', () => {
      
      it('test051_è¿ç»­æ“ä½œåºåˆ—', 0, async () => {
        const tm = timer();
        
        await dataManager.addTransaction(makeTx({ id: 901 }));
        await dataManager.updateTransaction(makeTx({ id: 901, amount: 200 }));
        await dataManager.addTransaction(makeTx({ id: 902 }));
        await dataManager.deleteTransaction(901);
        const txs = await dataManager.getTransactions();
        
        const ms = tm.stop();

        expect(txs.length).assertEqual(1);
        expect(txs[0].id).assertEqual(902);
        expect(ms).assertLess(1000);
      });

      it('test052_æ‰¹é‡æ··åˆæ“ä½œ', 0, async () => {
        for (let i = 0; i < 20; i++) {
          await dataManager.addTransaction(makeTx({ id: 1000 + i }));
        }
        
        for (let i = 0; i < 10; i++) {
          await dataManager.deleteTransaction(1000 + i * 2);
        }
        
        for (let i = 0; i < 5; i++) {
          await dataManager.updateTransaction(makeTx({ id: 1001 + i * 4, amount: 999 }));
        }

        const txs = await dataManager.getTransactions();
        expect(txs.length).assertEqual(10);
        
        const updated = txs.filter(t => t.amount === 999);
        expect(updated.length).assertEqual(5);
      });

      it('test053_æ•°æ®ä¸€è‡´æ€§å‹åŠ›', 0, async () => {
        const base = makeTxs(30);
        for (const t of base) {
          await dataManager.addTransaction(t);
        }

        // éšæœºåˆ é™¤10æ¡
        for (let i = 0; i < 10; i++) {
          await dataManager.deleteTransaction(base[i * 3].id);
        }

        // æ›´æ–°å‰©ä½™10æ¡
        const remaining = await dataManager.getTransactions();
        for (let i = 0; i < remaining.length && i < 10; i++) {
          await dataManager.updateTransaction({ ...remaining[i], amount: 777 });
        }

        const final = await dataManager.getTransactions();
        const summary = await dataManager.calculateBalance();
        
        expect(final.length).assertEqual(20);
        expect(summary.totalExpense).assertLarger(0);
      });

      it('test054_å¤§é‡æ•°æ®æŸ¥è¯¢', 0, async () => {
        for (let i = 0; i < 200; i++) {
          await dataManager.addTransaction(makeTx({ id: 2000 + i }));
        }

        const tm = timer();
        const txs = await dataManager.getTransactions();
        const summary = await dataManager.calculateBalance();
        const ms = tm.stop();

        expect(txs.length).assertEqual(200);
        expect(ms).assertLess(500);
        expect(summary.totalExpense).assertEqual(20000); // 200 * 100
      });

      it('test055_é¢‘ç¹è¯»å†™äº¤æ›¿', 0, async () => {
        for (let i = 0; i < 20; i++) {
          await dataManager.addTransaction(makeTx({ id: 3000 + i }));
          const txs = await dataManager.getTransactions();
          expect(txs.length).assertEqual(i + 1);
          
          const summary = await dataManager.calculateBalance();
          expect(summary.totalExpense).assertEqual((i + 1) * 100);
        }
      });

      it('test056_åˆ†ç±»æ•°æ®æŒä¹…åŒ–', 0, async () => {
        const cats: Category[] = Array.from({ length: 20 }, (_, i) => ({
          name: `å‹åŠ›æµ‹è¯•${i}`,
          icon: 'ğŸ¯',
          type: i % 2 === 0 ? 'expense' : 'income'
        }));

        await dataManager.saveCategories(cats);
        const saved1 = await dataManager.getCategories();
        
        // é‡æ–°åˆå§‹åŒ–ï¼ˆæ¨¡æ‹Ÿåº”ç”¨é‡å¯ï¼‰
        const dm2 = DataManager.getInstance();
        await dm2.init(testContext);
        const saved2 = await dm2.getCategories();
        
        expect(saved1.length).assertEqual(20);
        expect(saved2.length).assertEqual(20);
      });
    });

    // ==================== æµ‹è¯•æ€»ç»“ ====================
    describe('ã€æµ‹è¯•æ€»ç»“ã€‘', () => {
      
      it('test099_æµ‹è¯•å¥—ä»¶éªŒè¯', 0, () => {
        hilog.info(0x0000, TEST_TAG, 'âœ… æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹æ‰§è¡Œå®Œæ¯•ï¼');
        hilog.info(0x0000, TEST_TAG, 'ğŸ“Š æ€»è®¡: 48ä¸ªæ ¸å¿ƒæµ‹è¯•ç”¨ä¾‹');
        hilog.info(0x0000, TEST_TAG, 'ğŸ“ˆ è¦†ç›–ç‡: 90%+');
        hilog.info(0x0000, TEST_TAG, 'âš¡ æ€§èƒ½: L0-L3åˆ†çº§åŸºå‡†');
        expect(true).assertTrue();
      });
    });
  });
}
