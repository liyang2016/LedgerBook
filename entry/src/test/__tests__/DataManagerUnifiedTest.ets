import { describe, it, expect, beforeAll, beforeEach, afterEach, afterAll } from '@ohos/hypium';
import { DataManager, Transaction, Category, BalanceSummary } from '../../main/ets/services/DataManager';
import { hilog } from '@kit.PerformanceAnalysisKit';

/**
 * DataManager å…¼å®¹ ArkTS è§„èŒƒçš„æµ‹è¯•å¥—ä»¶
 * ä¿®å¤æ‰€æœ‰ç¼–è¯‘é”™è¯¯ï¼Œç¬¦åˆ HarmonyOS API 12 æ ‡å‡†
 */
export default function DataManagerUnifiedTest() {
  
  describe('DataManager Unified Test Suite', () => {
    
    let dataManager: DataManager;
    let testContext: Context;
    let idSeed: number = 1;
    const TEST_TAG: string = 'DMUnifiedTest';

    // ç”Ÿæˆå”¯ä¸€ID
    function genId(): number {
      return Date.now() + (idSeed++);
    }

    // åˆ›å»ºæ ‡å‡†æµ‹è¯•æ•°æ®
    function makeTx(title: string, amount: number, type: string, category: string, overrides: Record<string, Object>): Transaction {
      let tx: Transaction = {
        id: genId(),
        title: title,
        amount: amount,
        type: type as 'income' | 'expense',
        date: '2026-02-03',
        category: category
      };
      
      // æ‰‹åŠ¨åˆå¹¶è¦†ç›–å±æ€§
      if (overrides['id'] !== undefined) {
        tx.id = overrides['id'] as number;
      }
      if (overrides['date'] !== undefined) {
        tx.date = overrides['date'] as string;
      }
      
      return tx;
    }

    // æ‰¹é‡åˆ›å»ºæµ‹è¯•æ•°æ®
    function makeTxs(count: number, baseTitle: string, baseAmount: number): Transaction[] {
      let txs: Transaction[] = [];
      for (let i: number = 0; i < count; i++) {
        let t: Transaction = {
          id: genId(),
          title: baseTitle + i,
          amount: baseAmount * (i + 1),
          type: (i % 2 === 0) ? 'expense' : 'income',
          date: '2026-02-03',
          category: 'é¤é¥®'
        };
        txs.push(t);
      }
      return txs;
    }

    // ç”Ÿå‘½å‘¨æœŸé’©å­
    beforeAll(async () => {
      hilog.info(0x0000, TEST_TAG, 'ğŸš€ æµ‹è¯•å¥—ä»¶åˆå§‹åŒ–');
      try {
        dataManager = DataManager.getInstance();
        testContext = getContext();
        await dataManager.init(testContext);
        hilog.info(0x0000, TEST_TAG, 'âœ… åˆå§‹åŒ–å®Œæˆ');
      } catch (err) {
        hilog.error(0x0000, TEST_TAG, 'âŒ åˆå§‹åŒ–å¤±è´¥');
        throw err;
      }
    });

    beforeEach(async () => {
      idSeed = 1;
      await dataManager.saveTransactions([]);
    });

    afterEach(async () => {
      await dataManager.saveTransactions([]);
    });

    afterAll(() => {
      hilog.info(0x0000, TEST_TAG, 'ğŸ æµ‹è¯•å¥—ä»¶å®Œæˆ');
    });

    // ==================== åŸºç¡€CRUDæµ‹è¯• ====================
    describe('åŸºç¡€CRUDæµ‹è¯•', () => {
      
      it('test001_å•ä¾‹å®ä¾‹ä¸€è‡´æ€§', 0, () => {
        let i1: DataManager = DataManager.getInstance();
        let i2: DataManager = DataManager.getInstance();
        expect(i1 === i2).assertTrue();
      });

      it('test002_æ·»åŠ å•ç¬”äº¤æ˜“', 0, async () => {
        let t: Transaction = makeTx('åˆé¤', 35, 'expense', 'é¤é¥®', {});
        let ok: boolean = await dataManager.addTransaction(t);
        expect(ok).assertTrue();
        
        let txs: Transaction[] = await dataManager.getTransactions();
        expect(txs.length).assertEqual(1);
        expect(txs[0].title).assertEqual('åˆé¤');
      });

      it('test003_æ‰¹é‡æ·»åŠ äº¤æ˜“', 0, async () => {
        let txs: Transaction[] = makeTxs(5, 'äº¤æ˜“', 10);
        for (let i: number = 0; i < txs.length; i++) {
          await dataManager.addTransaction(txs[i]);
        }
        
        let saved: Transaction[] = await dataManager.getTransactions();
        expect(saved.length).assertEqual(5);
      });

      it('test004_æŸ¥è¯¢æ‰€æœ‰äº¤æ˜“', 0, async () => {
        await dataManager.addTransaction(makeTx('T1', 10, 'expense', 'é¤é¥®', { 'id': 101 }));
        await dataManager.addTransaction(makeTx('T2', 20, 'expense', 'é¤é¥®', { 'id': 102 }));

        let txs: Transaction[] = await dataManager.getTransactions();
        expect(txs.length).assertEqual(2);
      });

      it('test005_æ›´æ–°ç°æœ‰äº¤æ˜“', 0, async () => {
        await dataManager.addTransaction(makeTx('åŸ', 50, 'expense', 'é¤é¥®', { 'id': 201 }));
        let updated: Transaction = makeTx('æ–°', 75, 'expense', 'äº¤é€š', { 'id': 201 });
        let ok: boolean = await dataManager.updateTransaction(updated);
        expect(ok).assertTrue();
        
        let txs: Transaction[] = await dataManager.getTransactions();
        expect(txs[0].title).assertEqual('æ–°');
      });

      it('test006_åˆ é™¤æŒ‡å®šäº¤æ˜“', 0, async () => {
        await dataManager.addTransaction(makeTx('å¾…åˆ ', 100, 'expense', 'é¤é¥®', { 'id': 301 }));
        let ok: boolean = await dataManager.deleteTransaction(301);
        expect(ok).assertTrue();
        
        let txs: Transaction[] = await dataManager.getTransactions();
        expect(txs.length).assertEqual(0);
      });

      it('test007_åˆ é™¤åæ·»åŠ æ–°äº¤æ˜“', 0, async () => {
        await dataManager.addTransaction(makeTx('', 0, 'expense', 'é¤é¥®', { 'id': 401 }));
        await dataManager.deleteTransaction(401);
        await dataManager.addTransaction(makeTx('æ–°', 100, 'expense', 'é¤é¥®', { 'id': 402 }));

        let txs: Transaction[] = await dataManager.getTransactions();
        expect(txs.length).assertEqual(1);
        expect(txs[0].id).assertEqual(402);
      });

      it('test008_å¤šæ¬¡æ›´æ–°åŒä¸€äº¤æ˜“', 0, async () => {
        let id: number = 501;
        await dataManager.addTransaction(makeTx('', 100, 'expense', 'é¤é¥®', { 'id': id }));
        await dataManager.updateTransaction(makeTx('', 200, 'expense', 'é¤é¥®', { 'id': id }));
        await dataManager.updateTransaction(makeTx('', 300, 'expense', 'é¤é¥®', { 'id': id }));

        let txs: Transaction[] = await dataManager.getTransactions();
        expect(txs[0].amount).assertEqual(300);
      });

      it('test009_ç©ºåˆ—è¡¨æŸ¥è¯¢', 0, async () => {
        let txs: Transaction[] = await dataManager.getTransactions();
        expect(txs.length).assertEqual(0);
      });

      it('test010_æ‰¹é‡åˆ é™¤', 0, async () => {
        for (let i: number = 0; i < 5; i++) {
          await dataManager.addTransaction(makeTx('', 0, 'expense', 'é¤é¥®', { 'id': 600 + i }));
        }
        
        await dataManager.deleteTransaction(600);
        await dataManager.deleteTransaction(602);
        await dataManager.deleteTransaction(604);

        let txs: Transaction[] = await dataManager.getTransactions();
        expect(txs.length).assertEqual(2);
      });
    });

    // ==================== ä¸šåŠ¡é€»è¾‘æµ‹è¯• ====================
    describe('ä¸šåŠ¡é€»è¾‘æµ‹è¯•', () => {
      
      it('test011_è®¡ç®—æ··åˆæ”¶æ”¯ä½™é¢', 0, async () => {
        await dataManager.addTransaction(makeTx('å·¥èµ„', 5000, 'income', 'å·¥èµ„', {}));
        await dataManager.addTransaction(makeTx('æˆ¿ç§Ÿ', 2000, 'expense', 'ä½æˆ¿', {}));
        await dataManager.addTransaction(makeTx('é¤é¥®', 500, 'expense', 'é¤é¥®', {}));

        let summary: BalanceSummary = await dataManager.calculateBalance();
        expect(summary.totalIncome).assertEqual(5000);
        expect(summary.totalExpense).assertEqual(2500);
        expect(summary.balance).assertEqual(2500);
      });

      it('test012_çº¯æ”¯å‡ºä½™é¢ä¸ºè´Ÿ', 0, async () => {
        await dataManager.addTransaction(makeTx('', 100, 'expense', 'é¤é¥®', {}));
        await dataManager.addTransaction(makeTx('', 200, 'expense', 'é¤é¥®', {}));

        let summary: BalanceSummary = await dataManager.calculateBalance();
        expect(summary.balance).assertEqual(-300);
      });

      it('test013_çº¯æ”¶å…¥ä½™é¢ä¸ºæ­£', 0, async () => {
        await dataManager.addTransaction(makeTx('', 3000, 'income', 'å·¥èµ„', {}));
        await dataManager.addTransaction(makeTx('', 2000, 'income', 'å¥–é‡‘', {}));

        let summary: BalanceSummary = await dataManager.calculateBalance();
        expect(summary.balance).assertEqual(5000);
      });

      it('test014_è·å–é»˜è®¤åˆ†ç±»', 0, async () => {
        let cats: Category[] = await dataManager.getCategories();
        expect(cats.length > 0).assertTrue();
        
        let expense: Category[] = [];
        let income: Category[] = [];
        for (let i: number = 0; i < cats.length; i++) {
          if (cats[i].type === 'expense') {
            expense.push(cats[i]);
          } else {
            income.push(cats[i]);
          }
        }
        
        expect(expense.length > 0).assertTrue();
        expect(income.length > 0).assertTrue();
      });

      it('test015_ä¿å­˜è‡ªå®šä¹‰åˆ†ç±»', 0, async () => {
        let custom: Category[] = [
          { name: 'è‡ªå®šä¹‰1', icon: 'ğŸ¯', type: 'expense' },
          { name: 'è‡ªå®šä¹‰2', icon: 'ğŸ’', type: 'income' }
        ];
        
        let ok: boolean = await dataManager.saveCategories(custom);
        expect(ok).assertTrue();
        
        let saved: Category[] = await dataManager.getCategories();
        expect(saved.length).assertEqual(2);
      });

      it('test016_é›¶ä½™é¢åœºæ™¯', 0, async () => {
        await dataManager.addTransaction(makeTx('', 1000, 'income', 'å·¥èµ„', {}));
        await dataManager.addTransaction(makeTx('', 1000, 'expense', 'é¤é¥®', {}));

        let summary: BalanceSummary = await dataManager.calculateBalance();
        expect(summary.balance).assertEqual(0);
      });
    });

    // ==================== è¾¹ç•Œæ¡ä»¶æµ‹è¯• ====================
    describe('è¾¹ç•Œæ¡ä»¶æµ‹è¯•', () => {
      
      it('test021_é›¶é‡‘é¢äº¤æ˜“', 0, async () => {
        let t: Transaction = makeTx('', 0, 'expense', 'é¤é¥®', {});
        let ok: boolean = await dataManager.addTransaction(t);
        expect(ok).assertTrue();
      });

      it('test022_æœ€å¤§é‡‘é¢', 0, async () => {
        let t: Transaction = makeTx('', 999999.99, 'income', 'å·¥èµ„', {});
        let ok: boolean = await dataManager.addTransaction(t);
        expect(ok).assertTrue();
        
        let summary: BalanceSummary = await dataManager.calculateBalance();
        expect(summary.totalIncome).assertEqual(999999.99);
      });

      it('test023_ä¸¤ä½å°æ•°ç²¾åº¦', 0, async () => {
        let t: Transaction = makeTx('', 35.99, 'expense', 'é¤é¥®', {});
        await dataManager.addTransaction(t);
        
        let txs: Transaction[] = await dataManager.getTransactions();
        expect(txs[0].amount).assertEqual(35.99);
      });

      it('test024_ç©ºå­—ç¬¦ä¸²æ ‡é¢˜', 0, async () => {
        let t: Transaction = makeTx('', 100, 'expense', 'é¤é¥®', {});
        let ok: boolean = await dataManager.addTransaction(t);
        expect(ok).assertTrue();
      });

      it('test025_ç‰¹æ®Šå­—ç¬¦æ ‡é¢˜', 0, async () => {
        let special: string = 'æµ‹è¯•123';
        let t: Transaction = makeTx(special, 100, 'expense', 'é¤é¥®', {});
        let ok: boolean = await dataManager.addTransaction(t);
        expect(ok).assertTrue();
      });
    });

    // ==================== é”™è¯¯å¤„ç†æµ‹è¯• ====================
    describe('é”™è¯¯å¤„ç†æµ‹è¯•', () => {
      
      it('test031_æ›´æ–°ä¸å­˜åœ¨äº¤æ˜“', 0, async () => {
        let t: Transaction = makeTx('', 100, 'expense', 'é¤é¥®', { 'id': 99999 });
        let ok: boolean = await dataManager.updateTransaction(t);
        expect(ok).assertFalse();
      });

      it('test032_åˆ é™¤ä¸å­˜åœ¨äº¤æ˜“å¹‚ç­‰', 0, async () => {
        let ok: boolean = await dataManager.deleteTransaction(88888);
        expect(ok).assertTrue();
      });

      it('test033_æ“ä½œå¤±è´¥æ•°æ®ä¸€è‡´æ€§', 0, async () => {
        await dataManager.addTransaction(makeTx('ä¿ç•™', 100, 'expense', 'é¤é¥®', { 'id': 777 }));
        let before: number = (await dataManager.getTransactions()).length;

        await dataManager.updateTransaction(makeTx('', 100, 'expense', 'é¤é¥®', { 'id': 99999 }));
        
        let after: number = (await dataManager.getTransactions()).length;
        expect(after).assertEqual(before);
      });
    });

    // ==================== æ€§èƒ½åŸºå‡†æµ‹è¯• ====================
    describe('æ€§èƒ½åŸºå‡†æµ‹è¯•', () => {
      
      it('test041_å•æ¡æ·»åŠ æ€§èƒ½', 0, async () => {
        let start: number = Date.now();
        await dataManager.addTransaction(makeTx('', 100, 'expense', 'é¤é¥®', {}));
        let ms: number = Date.now() - start;
        
        expect(ms < 100).assertTrue();
        hilog.info(0x0000, TEST_TAG, 'L0å•æ¡æ·»åŠ : %{public}d ms', ms);
      });

      it('test042_æ‰¹é‡10æ¡æ€§èƒ½', 0, async () => {
        let txs: Transaction[] = makeTxs(10, 'T', 10);
        let start: number = Date.now();
        
        for (let i: number = 0; i < txs.length; i++) {
          await dataManager.addTransaction(txs[i]);
        }
        
        let ms: number = Date.now() - start;
        expect(ms < 500).assertTrue();
      });

      it('test043_æŸ¥è¯¢50æ¡æ€§èƒ½', 0, async () => {
        let txs: Transaction[] = makeTxs(50, 'Q', 10);
        for (let i: number = 0; i < txs.length; i++) {
          await dataManager.addTransaction(txs[i]);
        }

        let start: number = Date.now();
        let saved: Transaction[] = await dataManager.getTransactions();
        let ms: number = Date.now() - start;

        expect(saved.length).assertEqual(50);
        expect(ms < 100).assertTrue();
      });

      it('test044_ä½™é¢è®¡ç®—æ€§èƒ½', 0, async () => {
        let txs: Transaction[] = makeTxs(100, 'B', 10);
        for (let i: number = 0; i < txs.length; i++) {
          await dataManager.addTransaction(txs[i]);
        }

        let start: number = Date.now();
        await dataManager.calculateBalance();
        let ms: number = Date.now() - start;

        expect(ms < 100).assertTrue();
      });
    });

    // ==================== æµ‹è¯•æ€»ç»“ ====================
    describe('æµ‹è¯•æ€»ç»“', () => {
      
      it('test099_æµ‹è¯•å¥—ä»¶éªŒè¯', 0, () => {
        hilog.info(0x0000, TEST_TAG, 'âœ… æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹æ‰§è¡Œå®Œæ¯•ï¼');
        expect(true).assertTrue();
      });
    });
  });
}
